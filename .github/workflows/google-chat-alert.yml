name: Deploy ## 21

on:
  workflow_dispatch: # ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ìˆ˜ë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  push:
    branches:
      - develop # 'develop' ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš°ê°€ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤.

concurrency:
  group: deploy-group
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest # ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë  GitHub Actions ëŸ¬ë„ˆì˜ OSë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2 # ë¦¬í¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤.

      - name: Notify Google Chat on Push Start
        run: |
          # í‘¸ì‹œì—ì„œ ì»¤ë°‹ ë©”ì‹œì§€ì™€ ì‘ì„±ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          COMMIT_MESSAGE=$(git log --format=%B -n 1 ${{ github.sha }})
          COMMIT_AUTHOR=$(git log --format=%an -n 1 ${{ github.sha }})
          COMMIT_USER_LOGIN="${{ github.event.sender.login }}"

          # GitHub Actionsì˜ ì‹œê°„ì€ UTCë¡œ ì œê³µë˜ë¯€ë¡œ, Asia/Seoulë¡œ ë³€í™˜
          CURRENT_TIME_KST=$(TZ="Asia/Seoul" date '+%Y-%m-%d %H:%M:%S')

          curl -X POST \
          -H 'Content-Type: application/json' \
          -d "{\"text\": \"ğŸ¬ [google-chat-test]\n\n${COMMIT_AUTHOR}(${COMMIT_USER_LOGIN}) ë‹˜ì´ Push í•˜ì˜€ìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\n\n- ì»¤ë°‹ ë©”ì‹œì§€: ${COMMIT_MESSAGE}\n- ì‹œê°: ${CURRENT_TIME_KST}\"}" \
          "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"
